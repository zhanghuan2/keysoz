// Generated by CoffeeScript 1.6.3
(function() {
  var FileNotFoundError, ProxyMiddleware, app, dataProvider, env, express, fs, proxyKeys, proxyTable, render, _;

  require("./polyfill");

  _ = require("lodash");

  fs = require("fs");

  env = require("./enviroments");

  render = require("./handlebars/render");

  express = require("express");

  ProxyMiddleware = require("http-proxy-middleware");

  dataProvider = require("./data_provider");

  FileNotFoundError = require("./errors").FileNotFoundError;

  app = express();

  proxyTable = env.proxyTable;

  if (proxyTable) {
    proxyKeys = Object.keys(proxyTable);
    proxyKeys.forEach(function(key) {
      var middleware, opts;
      opts = proxyTable[key];
      middleware = new ProxyMiddleware(key, opts);
      return app.use(middleware);
    });
  }

  app.get(/^([^\.]+)$/, function(req, res, next) {
    var context, err, globalData, path, result, urlDataResult;
    path = req.params[0];
    urlDataResult = dataProvider.getUrlData(path, 'GET', req.query);
    globalData = dataProvider.getGlobalData();
    context = _.isPlainObject(urlDataResult.result) ? _.assign(req.query, urlDataResult.result) : req.query;
    context = _.assign(globalData, context);
    try {
      result = render.renderFile(path, context);
      return res.send(result);
    } catch (_error) {
      err = _error;
      if (err instanceof FileNotFoundError) {
        return next();
      } else {
        throw err;
      }
    }
  });

  app.get(/^(.+)$/, function(req, res, next) {
    var path, realPath;
    path = req.params[0];
    if (env.assetsPrefix !== void 0 && path.startsWith(env.assetsPrefix)) {
      path = path.substring(env.assetsPrefix.length);
    }
    realPath = "" + env.filesHome + path;
    if (fs.existsSync(realPath)) {
      return res.sendFile(realPath);
    } else {
      return next();
    }
  });

  app.all(/^(.+)$/, function(req, res) {
    var dataResult, path;
    path = req.params[0];
    dataResult = dataProvider.getUrlData(path, req.method, req.query);
    if (dataResult.found) {
      return res.send(dataResult.result);
    } else {
      console.log("[Not Found] " + path);
      res.status(404);
      return res.send();
    }
  });

  app.listen(env.serverPort);

  console.log("server listening at port: " + env.serverPort);

}).call(this);
